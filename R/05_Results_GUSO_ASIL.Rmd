---
title: "05_Results_GUSO_MB16"
author: "ML"
date: "2022-11-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Testing non-calibrated model procustus sparc responses

```{r}
load(file = "Fit/model_procustus0M.RData")
load(file = "Fit/model_procustus0M_d.RData")
load(file = "Fit/model_sparc0M.RData")
load(file = "Fit/model_sparc0M_d.RData")

BF_model_comparison_procustus0M <- do_BF_comparison(model_procustus0M,model_procustus0M_d)
post_analysis_procustus0M <- do_post_analysis(model_procustus0M)
hypothesis_test_procustus0M <- do_hypothesis_test(model_procustus0M)

BF_model_comparison_sparc0M <- do_BF_comparison(model_sparc0M,model_sparc0M_d)
post_analysis_sparc0M <- do_post_analysis(model_sparc0M)
hypothesis_test_sparc0M <- do_hypothesis_test(model_sparc0M)

save(file = "Results/BF_model_comparison_procustus0M.RData", BF_model_comparison_procustus0M)
save(file = "Results/post_analysis_procustus0M.RData", post_analysis_procustus0M)
save(file = "Results/hypothesis_test_procustus0M.RData", hypothesis_test_procustus0M)

save(file = "Results/BF_model_comparison_sparc0M.RData", BF_model_comparison_sparc0M)
save(file = "Results/post_analysis_sparc0M.RData", post_analysis_sparc0M)
save(file = "Results/hypothesis_test_sparc0M.RData", hypothesis_test_sparc0M)
```

# Testing calibrated model procustus sparc responses

```{r}
load(file = "Fit/model_procustus1M.RData")
load(file = "Fit/model_procustus1M_d.RData")
load(file = "Fit/model_sparc1M.RData")
load(file = "Fit/model_sparc1M_d.RData")

BF_model_comparison_procustus1M <- do_BF_comparison(model_procustus1M,model_procustus1M_d)
post_analysis_procustus1M <- do_post_analysis(model_procustus1M)
hypothesis_test_procustus1M <- do_hypothesis_test(model_procustus1M)

BF_model_comparison_sparc1M <- do_BF_comparison(model_sparc1M,model_sparc1M_d)
post_analysis_sparc1M <- do_post_analysis(model_sparc1M)
hypothesis_test_sparc1M <- do_hypothesis_test(model_sparc1M)

save(file = "Results/BF_model_comparison_procustus1M.RData", BF_model_comparison_procustus1M)
save(file = "Results/post_analysis_procustus1M.RData", post_analysis_procustus1M)
save(file = "Results/hypothesis_test_procustus1M.RData", hypothesis_test_procustus1M)

save(file = "Results/BF_model_comparison_sparc1M.RData", BF_model_comparison_sparc1M)
save(file = "Results/post_analysis_sparc1M.RData", post_analysis_sparc1M)
save(file = "Results/hypothesis_test_sparc1M.RData", hypothesis_test_sparc1M)
```

### A view on trial distributions
#### Procustus over trials
```{r}
load(file = "Fit/model_procustus1M.RData")
fit <- model_procustus1M

sd <- fit %>% spread_draws(`r_condition:trial`[A,Intercept],`b_condition1`,`b_condition2`) 
sd_11 <- sd %>% filter(A == c("1_1")) %>% mutate(ct_values = `r_condition:trial` + `b_condition1`, ct_names = "1_1", c = "1", t = "1" )
sd_12 <- sd %>% filter(A == c("1_2")) %>% mutate(ct_values = `r_condition:trial` + `b_condition1`, ct_names = "1_2", c = "1", t = "2" )
sd_13 <- sd %>% filter(A == c("1_3")) %>% mutate(ct_values = `r_condition:trial` + `b_condition1`, ct_names = "1_3", c = "1", t = "3" )
sd_14 <- sd %>% filter(A == c("1_4")) %>% mutate(ct_values = `r_condition:trial` + `b_condition1`, ct_names = "1_4", c = "1", t = "4" )
sd_21 <- sd %>% filter(A == c("2_1")) %>% mutate(ct_values = `r_condition:trial` + `b_condition2`, ct_names = "2_1", c = "2", t = "1" )
sd_22 <- sd %>% filter(A == c("2_2")) %>% mutate(ct_values = `r_condition:trial` + `b_condition2`, ct_names = "2_2", c = "2", t = "2" )
sd_23 <- sd %>% filter(A == c("2_3")) %>% mutate(ct_values = `r_condition:trial` + `b_condition2`, ct_names = "2_3", c = "2", t = "3" )
sd_24 <- sd %>% filter(A == c("2_4")) %>% mutate(ct_values = `r_condition:trial` + `b_condition2`, ct_names = "2_4", c = "2", t = "4" )

sd_ct <- rbind(sd_11, sd_12, sd_13, sd_14, sd_21, sd_22, sd_23, sd_24)

p1 <- sd_ct %>% 
  ggplot(aes(x= t, y = ct_values, color = c)) + 
  stat_pointinterval(.width = c(.5,.95), position = position_dodge(width = 0.2)) +
  theme_bw() +
  xlab("trial") +
  ylab("Post. distr. (ci-50/95%) of condition and trials") +
  ggtitle("Procustus calibrated")

make_fig("FiguresPaper/ConditionTrialsPostDistr_Procustus1M",p1)

```


#### Sparc over trials
```{r}
load(file = "Fit/model_sparc1M.RData")
fit <- model_sparc1M

sd <- fit %>% spread_draws(`r_condition:trial`[A,Intercept],`b_condition1`,`b_condition2`) 
sd_11 <- sd %>% filter(A == c("1_1")) %>% mutate(ct_values = `r_condition:trial` + `b_condition1`, ct_names = "1_1", c = "1", t = "1" )
sd_12 <- sd %>% filter(A == c("1_2")) %>% mutate(ct_values = `r_condition:trial` + `b_condition1`, ct_names = "1_2", c = "1", t = "2" )
sd_13 <- sd %>% filter(A == c("1_3")) %>% mutate(ct_values = `r_condition:trial` + `b_condition1`, ct_names = "1_3", c = "1", t = "3" )
sd_14 <- sd %>% filter(A == c("1_4")) %>% mutate(ct_values = `r_condition:trial` + `b_condition1`, ct_names = "1_4", c = "1", t = "4" )
sd_21 <- sd %>% filter(A == c("2_1")) %>% mutate(ct_values = `r_condition:trial` + `b_condition2`, ct_names = "2_1", c = "2", t = "1" )
sd_22 <- sd %>% filter(A == c("2_2")) %>% mutate(ct_values = `r_condition:trial` + `b_condition2`, ct_names = "2_2", c = "2", t = "2" )
sd_23 <- sd %>% filter(A == c("2_3")) %>% mutate(ct_values = `r_condition:trial` + `b_condition2`, ct_names = "2_3", c = "2", t = "3" )
sd_24 <- sd %>% filter(A == c("2_4")) %>% mutate(ct_values = `r_condition:trial` + `b_condition2`, ct_names = "2_4", c = "2", t = "4" )

sd_ct <- rbind(sd_11, sd_12, sd_13, sd_14, sd_21, sd_22, sd_23, sd_24)

p1 <- sd_ct %>% 
  ggplot(aes(x= t, y = ct_values, color = c)) + 
  stat_pointinterval(.width = c(.5,.95), position = position_dodge(width = 0.2)) +
  theme_bw() +
  xlab("trial") +
  ylab("Post. distr. (ci-50/95%) of condition and trials") +
  ggtitle("Sparc calibrated")

make_fig("FiguresPaper/ConditionTrialsPostDistr_Sparc1M",p1)

```






# Testing TSM responses (obtained from smooths)

```{r}
load(file = "Fit/model_procustusTSM.RData")
load(file = "Fit/model_procustusTSM_d.RData")

BF_model_comparison_procustusTSM <- do_BF_comparison(model_procustusTSM,model_procustusTSM_d)
post_analysis_procustusTSM <- do_post_analysis(model_procustusTSM)
hypothesis_test_procustusTSM <- do_hypothesis_test(model_procustusTSM)


save(file = "Results/BF_model_comparison_procustusTSM.RData", BF_model_comparison_procustusTSM)
save(file = "Results/post_analysis_procustusTSM.RData", post_analysis_procustusTSM)
save(file = "Results/hypothesis_test_procustusTSM.RData", hypothesis_test_procustusTSM)

```

#### Sparc over trials
```{r}
load(file = "Fit/model_procustusTSM.RData")
fit <- model_procustusTSM

sd <- fit %>% spread_draws(`r_condition:trial`[A,Intercept],`b_condition1`,`b_condition2`) 
sd_11 <- sd %>% filter(A == c("1_1")) %>% mutate(ct_values = `r_condition:trial` + `b_condition1`, ct_names = "1_1", c = "1", t = "1" )
sd_12 <- sd %>% filter(A == c("1_2")) %>% mutate(ct_values = `r_condition:trial` + `b_condition1`, ct_names = "1_2", c = "1", t = "2" )
sd_13 <- sd %>% filter(A == c("1_3")) %>% mutate(ct_values = `r_condition:trial` + `b_condition1`, ct_names = "1_3", c = "1", t = "3" )
sd_14 <- sd %>% filter(A == c("1_4")) %>% mutate(ct_values = `r_condition:trial` + `b_condition1`, ct_names = "1_4", c = "1", t = "4" )
sd_21 <- sd %>% filter(A == c("2_1")) %>% mutate(ct_values = `r_condition:trial` + `b_condition2`, ct_names = "2_1", c = "2", t = "1" )
sd_22 <- sd %>% filter(A == c("2_2")) %>% mutate(ct_values = `r_condition:trial` + `b_condition2`, ct_names = "2_2", c = "2", t = "2" )
sd_23 <- sd %>% filter(A == c("2_3")) %>% mutate(ct_values = `r_condition:trial` + `b_condition2`, ct_names = "2_3", c = "2", t = "3" )
sd_24 <- sd %>% filter(A == c("2_4")) %>% mutate(ct_values = `r_condition:trial` + `b_condition2`, ct_names = "2_4", c = "2", t = "4" )

sd_ct <- rbind(sd_11, sd_12, sd_13, sd_14, sd_21, sd_22, sd_23, sd_24)

p1 <- sd_ct %>% 
  ggplot(aes(x= t, y = ct_values, color = c)) + 
  stat_pointinterval(.width = c(.5,.95), position = position_dodge(width = 0.2)) +
  theme_bw() +
  xlab("trial") +
  ylab("Post. distr. (ci-50/95%) of condition and trials") +
  ggtitle("ProcustusTSM")

make_fig("FiguresPaper/ConditionTrialsPostDistr_procustusTSM",p1)

```




# ##############################

# questionnaires
# ##############################

# Testing non-Multivariate questionnaire models

```{r testing, eval=FALSE, include=FALSE}

load(file = "Fit/modelH3_WPQ.RData")
load(file = "Fit/modelH3response0M_WPQ.RData")
load(file = "Fit/modelH3response1M_WPQ.RData")

load(file = "Fit/modelH3_MPQS.RData")
load(file = "Fit/modelH3response0M_MPQS.RData")
load(file = "Fit/modelH3response1M_MPQS.RData")

load(file = "Fit/modelH3_MPQP.RData")
load(file = "Fit/modelH3response0M_MPQP.RData")
load(file = "Fit/modelH3response1M_MPQP.RData")

load(file = "Fit/modelH3_Difficulty.RData")
load(file = "Fit/modelH3response0M_Difficulty.RData")
load(file = "Fit/modelH3response1M_Difficulty.RData")

# All models are procustus based
# 1. Bayes_test: Is model_1 (without Response) better than model_2 (with?)
BF_model_comparison_WPQ_0M <- do_BF_comparison(modelH3_WPQ,modelH3response0M_WPQ)
BF_model_comparison_MPQS_0M <- do_BF_comparison(modelH3_MPQS,modelH3response0M_MPQS)
BF_model_comparison_MPQP_0M <- do_BF_comparison(modelH3_MPQP,modelH3response0M_MPQP)
BF_model_comparison_Difficulty_0M <- do_BF_comparison(modelH3_Difficulty,modelH3response0M_Difficulty)

BF_model_comparison_WPQ_1M <- do_BF_comparison(modelH3_WPQ,modelH3response1M_WPQ)
BF_model_comparison_MPQS_1M <- do_BF_comparison(modelH3_MPQS,modelH3response1M_MPQS)
BF_model_comparison_MPQP_1M <- do_BF_comparison(modelH3_MPQP,modelH3response1M_MPQP)
BF_model_comparison_Difficulty_1M <- do_BF_comparison(modelH3_Difficulty,modelH3response1M_Difficulty)


# 2. Diagnostics: Given that model_2 (with Response) is not better, proceed with model_1 only
post_analysis_procustus_basicWPQ <- do_post_analysis(modelH3_WPQ) #basic model
post_analysis_procustus_basicMPQS <- do_post_analysis(modelH3_MPQS) #basic model
post_analysis_procustus_basicMPQP <- do_post_analysis(modelH3_MPQP) #basic model
post_analysis_procustus_basicDifficulty <- do_post_analysis(modelH3_Difficulty) #basic model

# Contrasts: 
# 
Contrast_WPQ <- do_hypothesis_test_Q(modelH3_WPQ)
Contrast_MPQS <- do_hypothesis_test_Q(modelH3_MPQS)
Contrast_WPQP <- do_hypothesis_test_Q(modelH3_MPQP)
Contrast_Difficulty <- do_hypothesis_test_Q(modelH3_Difficulty)

save(file = "Results/Contrast_WPQ.RData", Contrast_WPQ)
save(file = "Results/Contrast_MPQS.RData", Contrast_MPQS)
save(file = "Results/Contrast_MPQP.RData", Contrast_WPQP)
save(file = "Results/Contrast_Difficulty.RData", Contrast_Difficulty)



save(file = "Results/BF_model_comparison_WPQ_0M.RData", BF_model_comparison_WPQ_0M)
save(file = "Results/BF_model_comparison_MPQS_0M.RData", BF_model_comparison_MPQS_0M)
save(file = "Results/BF_model_comparison_MPQP_0M.RData", BF_model_comparison_MPQP_0M)
save(file = "Results/BF_model_comparison_Difficulty_0M.RData", BF_model_comparison_Difficulty_0M)

save(file = "Results/BF_model_comparison_WPQ_1M.RData", BF_model_comparison_WPQ_1M)
save(file = "Results/BF_model_comparison_MPQS_1M.RData", BF_model_comparison_MPQS_1M)
save(file = "Results/BF_model_comparison_MPQP_1M.RData", BF_model_comparison_MPQP_1M)
save(file = "Results/BF_model_comparison_Difficulty_1M.RData", BF_model_comparison_Difficulty_1M)


save(file = "Results/post_analysis_procustus_basicWPQ.RData", post_analysis_procustus_basicWPQ)
save(file = "Results/post_analysis_procustus_basicMPQS.RData", post_analysis_procustus_basicMPQS)
save(file = "Results/post_analysis_procustus_basicMPQP.RData", post_analysis_procustus_basicMPQP)
save(file = "Results/post_analysis_procustus_basicDifficulty.RData", post_analysis_procustus_basicDifficulty)

```

# Hypothesis 3: Procustus - non-calibrated non-Multivariate models
```{r H3proc1, echo=TRUE}
load(file = "Results/post_analysis_procustus_basicWPQ.RData")
load(file = "Results/post_analysis_procustus0M_WPQ.RData")
load(file = "Results/hypothesis_test_procustus_basicWPQ.RData")
load(file = "Results/hypothesis_test_procustus0M_WPQ.RData")
load(file = "Results/comparison_basic_procustus_WPQ.RData")

load(file = "Results/post_analysis_procustus_basicMPQS.RData")
load(file = "Results/post_analysis_procustus0M_MPQS.RData")
load(file = "Results/hypothesis_test_procustus_basicMPQS.RData")
load(file = "Results/hypothesis_test_procustus0M_MPQS.RData")
load(file = "Results/comparison_basic_procustus_MPQS.RData")

load(file = "Results/post_analysis_procustus_basicMPQP.RData")
load(file = "Results/post_analysis_procustus0M_MPQP.RData")
load(file = "Results/hypothesis_test_procustus_basicMPQP.RData")
load(file = "Results/hypothesis_test_procustus0M_MPQP.RData")
load(file = "Results/comparison_basic_procustus_MPQP.RData")


# basicWPQ
post_analysis_procustus_basicWPQ
hypothesis_test_procustus_basicWPQ
# metricWPQ
post_analysis_procustus0M_WPQ
hypothesis_test_procustus0M_WPQ
# comparison basicWPQ and metricWPQ
comparison_basic_procustus_WPQ

# basicMPQS
post_analysis_procustus_basicMPQS
hypothesis_test_procustus_basicMPQS
# metricMPQS
post_analysis_procustus0M_MPQS
hypothesis_test_procustus0M_MPQS
# comparison basicMPQS and metricMPQS
comparison_basic_procustus_MPQS

# basicMPQP
post_analysis_procustus_basicMPQP
hypothesis_test_procustus_basicMPQP
# metricMPQP
post_analysis_procustus0M_MPQP
hypothesis_test_procustus0M_MPQP
# comparison basicMPQP and metricMPQP
comparison_basic_procustus_MPQP
```

# Hypothesis 3: Multivariate model procustus non-cali
```{r H3proc1, echo=TRUE}


load("Results/post_analysis_Multi_basic.RData")
load("Results/hypothesis_testH3_Multi_basic_WPQ.RData")
load("Results/hypothesis_testH3_Multi_basic_MPQS.RData")
load("Results/hypothesis_testH3_Multi_basic_MPQP.RData")


load(file = "Results/post_analysis_Multi_metric.RData")
load(file = "Results/hypothesis_testH3_Multi_metric_WPQ.RData")
load(file = "Results/hypothesis_testH3_Multi_metric_MPQS.RData")
load(file = "Results/hypothesis_testH3_Multi_metric_MPQP.RData")
load(file = "Results/comparison_procustus_Multi_metric.RData")

# multivariate model basic
post_analysis_Multi_basic
hypothesis_testH3_Multi_basic_WPQ
hypothesis_testH3_Multi_basic_MPQS
hypothesis_testH3_Multi_basic_MPQP




# multivariate model metric
post_analysis_Multi_metric
hypothesis_testH3_Multi_metric_WPQ
hypothesis_testH3_Multi_metric_MPQS
hypothesis_testH3_Multi_metric_MPQP

# comparison basic and metric
comparison_procustus_Multi_metric



```

# Hypothesis 3: Procustus - calibrated
```{r H3proc2, eval=FALSE, include=FALSE}


load(file = "Results/post_analysis_procustus1M_WPQ.RData")
load(file = "Results/hypothesis_test_procustus1M_WPQ.RData")

load(file = "Results/post_analysis_procustus1M_MPQS.RData")
load(file = "Results/hypothesis_test_procustus1M_MPQS.RData")

load(file = "Results/post_analysis_procustus1M_MPQP.RData")
load(file = "Results/hypothesis_test_procustus1M_MPQP.RData")

post_analysis_procustus1M_WPQ
hypothesis_test_procustus1M_WPQ
post_analysis_procustus1M_MPQS
hypothesis_test_procustus1M_MPQS
post_analysis_procustus1M_MPQP
hypothesis_test_procustus1M_MPQP
```

# Timeseries: Extra check via gams

The conclusion is that the models show better results (higher post.probs) but there is no difference in conclusion from previous models.

```{r extracheck, eval=FALSE, include=FALSE}
formTSM_procustus <- bf(responseTSM_procustus ~ 1 + condition  + MSI_s + (1 | condition:participant) + (1|condition:trial) )
priorTSM <- c(brms::prior(normal(0, 3), class = "b"))
model_procustusTSM <- run_model_cmdstanr(Data,formTSM_procustus,"skew_normal",priorTSM)
post_analysis_procustusTSM <- do_post_analysis(model_procustusTSM)
hypothesis_testTSM <- do_hypothesis_test(model_procustusTSM)

priorTSM_basic <- c(brms::prior(normal(0, 3), class = "b"))
priorTSM <- c(brms::prior(normal(0, 3), class = "b"), 
             brms::prior(normal(0,3), class = "b", coef = "responseTSM_procustus"))
formH3responseTSM_procustus_basic <- bf(WPQ ~ 1 + condition  + MSI_s  +  (1  |  condition:participant + condition:trial))
formH3responseTSM_procustus <- bf(WPQ ~ 1 + responseTSM_procustus * condition  + MSI_s  +  (1  |  condition:participant + condition:trial))

modelH3responseTSM_WPQ_basic <- run_model_cmdstanr(Data,formH3responseTSM_procustus_basic,"gaussian",priorTSM_basic)
modelH3responseTSM_WPQ <- run_model_cmdstanr(Data,formH3responseTSM_procustus,"gaussian",priorTSM )


post_analysis_procustusTSM_basic <- do_post_analysis(modelH3responseTSM_WPQ_basic)
hypothesis_testTSM_basic <- do_hypothesis_test(modelH3responseTSM_WPQ_basic)
post_analysis_procustusTSM_WPQ <- do_post_analysis(modelH3responseTSM_WPQ)
hypothesis_test_procustusTSM_WPQ <- hypothesis(modelH3responseTSM_WPQ,"b_responseTSM_procustus:condition2 + b_condition2 > b_responseTSM_procustus", class = NULL)

comparison_basic_procustusTSM_WPQ <- do_comparison(modelH3responseTSM_WPQ_basic,modelH3responseTSM_WPQ)


save(file = "Results/model_procustusTSM.RData",model_procustusTSM)
save(file = "Results/modelH3responseTSM_WPQ_basic.RData",modelH3responseTSM_WPQ_basic)
save(file = "Results/modelH3responseTSM_WPQ.RData",modelH3responseTSM_WPQ)



save(file = "Results/post_analysis_procustusTSM.RData"   ,post_analysis_procustusTSM)  
save(file = "Results/hypothesis_testTSM.RData",hypothesis_testTSM)
   save (file = "Results/post_analysis_procustusTSM_basic.RData",post_analysis_procustusTSM_basic)
   save (file = "Results/hypothesis_testTSM_basic.RData",hypothesis_testTSM_basic)
   save (file = "Results/post_analysis_procustusTSM_WPQ.RData",post_analysis_procustusTSM_WPQ)
   save (file = "Results/hypothesis_test_procustusTSM_WPQ.RData",hypothesis_test_procustusTSM_WPQ)
   
   save(file = "Results/comparison_basic_procustusTSM_WPQ.RData", comparison_basic_procustusTSM_WPQ)

```

```{r extracheckshow, echo=TRUE}
load("Results/post_analysis_procustusTSM.RData")    
load("Results/hypothesis_testTSM.RData")
load("Results/post_analysis_procustusTSM_basic.RData")
load("Results/hypothesis_testTSM_basic.RData")
    load("Results/post_analysis_procustusTSM_WPQ.RData")
    load("Results/hypothesis_test_procustusTSM_WPQ.RData")
   load("Results/comparison_basic_procustusTSM_WPQ.RData")

    
# Time series model (calibrated per group) procustus
post_analysis_procustusTSM     
hypothesis_testTSM
# WPQ basic (without metric)
    post_analysis_procustusTSM_basic
    hypothesis_testTSM_basic
# WPQ (with metric)
    post_analysis_procustusTSM_WPQ
    hypothesis_test_procustusTSM_WPQ
# Comparison basic model (without metric) versus model with metric
  comparison_basic_procustusTSM_WPQ
```
          
      

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.





